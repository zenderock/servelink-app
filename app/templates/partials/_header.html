{% from "macros/dropdown-menu.html" import dropdown_menu %}
{% from "macros/avatar.html" import avatar with context %}
{% from "macros/dialog.html" import dialog %}
{% call dialog(
title=_("New team"),
description=_("Create a new team to manage your projects."),
id="dialog-new-team",
trigger_attrs={"role": "menuitem"},
dialog_attrs={"class": "w-full max-w-xl"},
body_attrs={"class": "space-y-4"}
) %}
<div hx-get="{{ url_for('new_team') }}" hx-trigger="toggle from:closest dialog once" class="min-h-[114px] relative">
	<div class="htmx-indicator flex items-center justify-center inset-0 absolute bg-background/80">
		<div class="flex items-center gap-x-2 text-muted-foreground [&>svg]:size-4 [&>svg]:animate-spin">
			{% include "icons/loader.svg" %}
			{{ _('Saving') }}
		</div>
	</div>
</div>
{% endcall %}
{% set trigger %}{% include "icons/chevrons-up-down.svg" %}{% endset %}
<header class="sticky top-0 bg-background z-20 border-b px-8 flex flex-col gap-y-2">
	<div class="flex items-center justify-between gap-x-4 h-16">
		<nav class="flex items-center gap-x-1.5 sm:gap-x-2.5">
			<a href="/" class="w-8 h-8 shrink-0 flex items-center justify-center" aria-label="{{ app_name }}"
				x-boost="true">
				<img src="{{ url_for('assets', path='/logo.svg') }}" alt="{{ app_name }}" class="w-8 h-8" />
			</a>

			{% if current_user %}
			{% if team %}
			<div class="text-muted-foreground/25 text-xl">/</div>
			<div class="flex items-center">
				<a href="{{ url_for('team_index', team_slug=team.slug) }}"
					class="btn-sm-ghost pl-2 {% if project or deployment %}pr-2{% endif %}" hx-boost="true">
					{{ avatar(item=team, prefix="team", name=team.name, size="xs") }}
					<span {% if project or deployment %}class="max-sm:hidden" {% endif %}>{{ team.name }}</span>
					{% if team.current_plan %}
					<span class="ml-1 px-1.5 py-0.5 text-xs font-medium rounded-full
						{% if team.current_plan.name == 'free' %}
							bg-muted text-muted-foreground
						{% else %}
							bg-primary/10 text-primary
						{% endif %}">
						{{ team.current_plan.display_name }}
					</span>
					{% else %}
					<span class="ml-1 px-1.5 py-0.5 text-xs font-medium rounded-full bg-muted text-muted-foreground">
						Free
					</span>
					{% endif %}
				</a>
				{% call dropdown_menu(
				trigger=trigger,
				trigger_attrs={"class": "btn-sm-ghost text-muted-foreground w-6"},
				popover_attrs={"data-align": "start"}
				) %}
				{% include "partials/_menu-teams.html" %}
				{% endcall %}
			</div>
			{% endif %}

			{% if project %}
			<div class="text-muted-foreground/25 text-xl">/</div>

			<div class="flex items-center">
				<a href="{{ url_for('project_index', team_slug=team.slug, project_name=project.name) }}"
					class="btn-sm-ghost pl-2 {% if deployment %}pr-2{% endif %}" hx-boost="true">
					{% from "macros/avatar.html" import avatar with context %}
					{{ avatar(item=project, prefix="project", name=project.name, size="xs") }}
					<span {% if deployment %}class="max-sm:hidden" {% endif %}>{{ project.name }}</span>
				</a>
				{% call dropdown_menu(
				trigger=trigger,
				trigger_attrs={"class": "btn-sm-ghost text-muted-foreground w-6"},
				popover_attrs={"data-align": "start"}
				) %}
				{% include "partials/_menu-projects.html" %}
				{% endcall %}
			</div>
			{% endif %}

			{% if deployment %}
			<div class="text-muted-foreground/25 text-xl">/</div>

			<div class="flex items-center">
				<a href="{{ url_for('project_deployment', team_slug=team.slug, project_name=project.name, deployment_id=deployment.id) }}"
					class="btn-sm-ghost" hx-boost="true">
					{% from "deployment/macros/status.html" import status %}
					{{ status(
					conclusion=deployment.conclusion,
					compact=True,
					attrs={ 'data-deployment-status': deployment.id }
					) }}
					<span class="font-mono text-[13px]">{{ deployment.id[:7] }}</span>
				</a>
				{% call dropdown_menu(
				trigger=trigger,
				trigger_attrs={"class": "btn-sm-ghost text-muted-foreground w-6"},
				popover_attrs={"data-align": "start"}
				) %}
				{% include "partials/_menu-deployments.html" %}
				{% endcall %}
			</div>

			<div hx-ext="sse" sse-connect="{{ url_for('project_event', team_id=team.id, project_id=project.id) }}"
				sse-close="sse:stream_closed">
				<div sse-swap="deployment_status_update"></div>
			</div>
			{% endif %}
			{% endif %}
		</nav>

		<nav class="flex items-center gap-x-2" aria-label="User menu">
			{% set trigger %}
			{% include "icons/circle-question-mark.svg" %}
			{% endset %}
			{% call dropdown_menu(
			trigger=trigger,
			trigger_attrs={"class": "btn-sm-icon-ghost rounded-full max-sm:hidden"},
			popover_attrs={"data-align": "end"}
			) %}
			<a href="https://changelog.servel.ink/" target="_blank" role="menuitem">
				{{ _('Changelog') }}
				<span class="ml-auto text-muted-foreground [&>svg]:size-3">
					{% include "icons/external-link.svg" %}
				</span>
			</a>
			{% endcall %}
			{% if current_user %}
			<div hx-get="{{ url_for('user_notifications') }}" hx-trigger="load" hx-swap="outerHTML">
				{% from "user/macros/notifications.html" import notifications with context %}
				{{ notifications() }}
			</div>
			{% set trigger %}
			{% set fallback %}
			<img src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ current_user.email }}&backgroundColor=b6e3f4,c0aede,d1d4f9,ffd5dc,ffdfbf&size=32"
				alt="{{ current_user.email }}" class="size-8 rounded-none shrink-0">
			{% endset %}
			{{ avatar(item=current_user, prefix="user", name=current_user.name if current_user.name else
			current_user.username, class="!rounded-none", fallback=fallback) }}
			{% endset %}
			{% call dropdown_menu(
			trigger=trigger,
			trigger_attrs={"class": "btn-icon-sm-ghost rounded-full shrink-0 p-0 border-0"},
			popover_attrs={"data-align": "end"}
			) %}
			<header class="px-2.5 py-1.5">
				<div class="font-medium">{{ current_user.name if current_user.name else current_user.username }}</div>
				<div class="text-muted-foreground">{{ current_user.email }}</div>
			</header>
			<hr role="separator" />
			<a href="{{ url_for('user_settings') }}" role="menuitem" hx-boost="true">{{ _('Account settings') }}</a>
			<a href="/" role="menuitem" hx-boost="true">{{ _('Default team') }}</a>
			<hr role="separator" />
			<button type="button" role="menuitem" onclick="document.dispatchEvent(new CustomEvent('basecoat:theme'))">
				<span class="hidden dark:block">{{ _('Theme: Light') }}</span>
				<span class="block dark:hidden">{{ _('Theme: Dark') }}</span>
				<span class="hidden dark:block ml-auto text-muted-foreground">{% include "icons/sun.svg" %}</span>
				<span class="block dark:hidden ml-auto text-muted-foreground">{% include "icons/moon.svg" %}</span>
			</button>

			<hr role="separator" class="sm:hidden" />

			<a href="https://changelog.servel.ink/" target="_blank" role="menuitem" class="sm:hidden">
				{{ _('Change Log') }}
				<span class="ml-auto text-muted-foreground [&>svg]:size-3">
					{% include "icons/external-link.svg" %}
				</span>
			</a>

			<hr role="separator" />
			<a href="{{ url_for('auth_logout') }}" role="menuitem">
				{{ _('Sign out') }}
			</a>
			{% endcall %}
			{% endif %}
		</nav>
	</div>

	{% if request.scope["route"].name.startswith("project_") %}
	{% include "partials/_tabs-project.html" %}
	{% endif %}
	{% if request.scope["route"].name.startswith("team_") %}
	{% include "partials/_tabs-team.html" %}
	{% endif %}
</header>
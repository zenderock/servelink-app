{% extends "layouts/app.html" %}

{% block title %}{{ article.title }} - {{ _("Knowledge Base") }}{% endblock %}

{% block app_content %}
<div class="container max-w-screen-lg mx-auto p-8 space-y-6">
  <!-- Breadcrumb -->
  <nav class="flex items-center gap-2 text-sm text-muted-foreground">
    <a href="{{ url_for('kb_index') }}" class="hover:text-foreground">{{ _("Knowledge Base") }}</a>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="9 18 15 12 9 6"/>
    </svg>
    <a href="{{ url_for('kb_category', category=article.category) }}" class="hover:text-foreground">{{ article.category|replace('_', ' ')|title }}</a>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="9 18 15 12 9 6"/>
    </svg>
    <span class="text-foreground">{{ article.title }}</span>
  </nav>

  <div class="grid gap-6 lg:grid-cols-3">
    <!-- Article Content -->
    <div class="lg:col-span-2 space-y-6">
      <div class="card">
        <div class="p-8">
          <h1 class="text-3xl font-bold mb-4">{{ article.title }}</h1>
          
          <div class="flex items-center gap-4 text-sm text-muted-foreground mb-6 pb-6 border-b">
            <span class="px-2 py-1 bg-muted rounded text-foreground">{{ article.category|replace('_', ' ')|title }}</span>
            <span>üëÅ {{ article.view_count }} {{ _("views") }}</span>
            <span>üìÖ {{ article.updated_at.strftime('%d %b %Y') }}</span>
          </div>

          <div class="prose prose-sm max-w-none">
            {{ article.content|safe }}
          </div>

          {% if article.tags %}
          <div class="mt-8 pt-6 border-t">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-sm text-muted-foreground">{{ _("Tags:") }}</span>
              {% for tag in article.tags %}
              <span class="px-2 py-1 text-xs bg-muted rounded">{{ tag }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Feedback -->
          <div class="mt-8 pt-6 border-t">
            <h3 class="font-semibold mb-4">{{ _("Was this article helpful?") }}</h3>
            <form method="post" action="{{ url_for('kb_feedback', article_id=article.id) }}" class="flex gap-3">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" name="helpful" value="yes" class="btn-secondary">
                üëç {{ _("Yes") }} ({{ article.helpful_count }})
              </button>
              <button type="submit" name="helpful" value="no" class="btn-secondary">
                üëé {{ _("No") }} ({{ article.not_helpful_count }})
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Related Articles -->
      {% if related_articles %}
      <div class="card">
        <header class="border-b px-6 py-4">
          <h2 class="font-semibold">{{ _("Related Articles") }}</h2>
        </header>
        <div class="divide-y">
          {% for related in related_articles %}
          <a href="{{ url_for('kb_article', slug=related.slug) }}" class="block px-6 py-4 hover:bg-muted/50 transition-colors">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <h3 class="font-medium mb-1">{{ related.title }}</h3>
                {% if related.excerpt %}
                <p class="text-sm text-muted-foreground line-clamp-1">{{ related.excerpt }}</p>
                {% endif %}
              </div>
              <svg class="flex-shrink-0 text-muted-foreground" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="space-y-4">
      <!-- Table of Contents -->
      <div class="card sticky top-[130px]">
        <header class="border-b px-6 py-4">
          <h3 class="font-semibold">{{ _("On this page") }}</h3>
        </header>
        <div class="p-6">
          <div id="toc" class="space-y-2 text-sm">
            <!-- TOC will be generated by JS -->
          </div>
        </div>
      </div>

      <!-- Need Help -->
      <div class="card">
        <div class="p-6">
          <h3 class="font-semibold mb-2">{{ _("Still need help?") }}</h3>
          <p class="text-sm text-muted-foreground mb-4">{{ _("Contact our support team") }}</p>
          <a href="{{ url_for('support_index') }}" class="btn-secondary w-full">
            {{ _("Contact Support") }}
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Generate Table of Contents
  const content = document.querySelector('.prose');
  const toc = document.getElementById('toc');
  
  if (content && toc) {
    const headings = content.querySelectorAll('h2, h3');
    
    if (headings.length > 0) {
      headings.forEach((heading, index) => {
        const id = `heading-${index}`;
        heading.id = id;
        
        const link = document.createElement('a');
        link.href = `#${id}`;
        link.className = `block hover:text-primary transition-colors ${heading.tagName === 'H3' ? 'pl-4' : ''}`;
        link.textContent = heading.textContent;
        
        toc.appendChild(link);
      });
    } else {
      toc.innerHTML = '<p class="text-sm text-muted-foreground">No sections</p>';
    }
  }
</script>
{% endblock %}

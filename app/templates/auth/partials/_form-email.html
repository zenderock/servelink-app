<form method="post" action="{{ url_for('auth_login') }}" class="form grid gap-4" hx-post="{{ url_for('auth_login') }}"
  hx-swap="outerHTML" hx-indicator="find .htmx-indicator" hx-swap="outerHTML" @htmx:before-send="loading = 'email'"
  @htmx:after-request="handleEmailSent()" x-data="emailCountdown()">
  {{ form.csrf_token }}
  <div class="grid gap-2">
    {{ form.email.label(class="sr-only") }}
    {{ form.email(
    class="input",
    placeholder=_("Enter your email"),
    **{
    ':disabled': 'loading || countdown > 0',
    }
    ) }}
    {% for error in form.email.errors %}
    <p class="text-destructive text-xs font-medium">{{ error }}</p>
    {% endfor %}
  </div>
  <button type="submit" class="btn" :disabled="loading || countdown > 0">
    {{ _("Continue with email") }}
    <span x-show="loading === 'email'" class="[&>svg]:size-4 [&>svg]:animate-spin">
      {% include "icons/loader.svg" %}
    </span>
  </button>
  <div x-show="countdown > 0" class="text-left space-y-2">
    <p class="text-sm text-muted-foreground">
      {{ _("Email sent! Please check your inbox.") }}
    </p>
    <p class="text-xs text-muted-foreground">
      {{ _("You can request a new link in") }} <span x-text="formatCountdown(countdown)"></span>
    </p>
  </div>
</form>

<script>
  function emailCountdown() {
    return {
      countdown: 0,
      interval: null,
      
      init() {
        // Restaurer le countdown depuis localStorage au chargement
        this.restoreCountdown();
        this.startCountdownIfNeeded();
      },
      
      restoreCountdown() {
        const storedExpiry = localStorage.getItem('email_login_expiry');
        if (storedExpiry) {
          const expiryTime = parseInt(storedExpiry);
          const now = Math.floor(Date.now() / 1000);
          const remaining = expiryTime - now;
          
          if (remaining > 0) {
            this.countdown = remaining;
          } else {
            // Expiré, nettoyer
            localStorage.removeItem('email_login_expiry');
            this.countdown = 0;
          }
        }
      },
      
      startCountdownIfNeeded() {
        if (this.countdown > 0) {
          this.interval = setInterval(() => {
            this.countdown--;
            if (this.countdown <= 0) {
              clearInterval(this.interval);
              localStorage.removeItem('email_login_expiry');
            }
          }, 1000);
        }
      },
      
      handleEmailSent() {
        this.loading = null;
        this.countdown = 120;
        
        // Sauvegarder le timestamp d'expiration dans localStorage
        const expiryTime = Math.floor(Date.now() / 1000) + 120;
        localStorage.setItem('email_login_expiry', expiryTime.toString());
        
        // Démarrer le countdown
        if (this.interval) {
          clearInterval(this.interval);
        }
        this.startCountdownIfNeeded();
      },
      
      formatCountdown(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }
    };
  }
</script>